name: Manual Quality Checks

on:
  workflow_dispatch:

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v1

      - name: Sync dependencies
        run: uv sync --frozen

      - name: Validate Claude permissions
        run: |
          if [ -x "./ci_validate_claude.sh" ]; then
            ./ci_validate_claude.sh --json
          else
            echo "ci_validate_claude.sh not found; skipping"
          fi

      - name: Run Ruff
        run: uv run ruff check .

      - name: Run pytest
        run: |
          if [ -d "tests" ]; then
            uv run pytest -q
          else
            echo "No tests directory found; skipping pytest."
          fi

      - name: Publish summary
        run: |
          {
            echo "## ARES Quality Checks";
            echo "- uv sync --frozen";
            echo "- uv run ruff check .";
            echo "- uv run pytest -q";
            echo "- ./ci_validate_claude.sh --json";
          } >> "$GITHUB_STEP_SUMMARY"
